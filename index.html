<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ladezeit & Kosten</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 24px auto; padding: 0 14px; }
    h1 { text-align: center; }
    label { display:block; margin-top: 12px; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-top: 6px; }
    button { margin-top: 14px; width: 100%; padding: 12px; font-size: 16px; font-weight: 600; }
    .out { margin-top: 18px; padding: 14px; background: #f3f3f3; border-radius: 10px; line-height: 1.6; }
    small { color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
    .warn { color: #8a2d2d; font-weight: 600; }
  </style>
</head>

<body>
  <h1>Ladezeit & Kosten</h1>

  <label>Akkukapazität (kWh)
    <input id="cap" type="text" value="69">
  </label>

  <label>Ladeleistung (kW)
    <input id="power" type="text" value="2">
  </label>

  <label>Ankunft (%)
    <input id="start" type="text" value="35">
  </label>

  <label>Ziel (%)
    <input id="target" type="text" value="80">
  </label>

  <label>Ladeverluste (%)
    <input id="loss" type="text" value="12">
  </label>

  <label>Strompreis (€/kWh)
    <input id="price" type="text" value="0,35">
  </label>

  <button type="button" onclick="calcAndSave()">Berechnen (automatisch speichern)</button>
  <button type="button" onclick="exportCSV()">CSV exportieren</button>
  <button type="button" onclick="clearCSV()">CSV zurücksetzen</button>

  <div class="out" id="out">Ergebnis erscheint hier.</div>

<script>
const STORAGE_KEY = "ladezeit_csv_v6";

const nf2 = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const nf3 = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 3, maximumFractionDigits: 3 });

function fmtEUR(x) { return nf2.format(x) + " €"; }
function fmtKWh(x) { return nf2.format(x) + " kWh"; }
function fmtKW(x) { return nf2.format(x) + " kW"; }
function fmtPct(x) { return nf2.format(x) + " %"; }

function fmtTime(hours) {
  const totalMinutes = Math.round(hours * 60);
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${h} h ${String(m).padStart(2,'0')} min`;
}

function show(html) {
  document.getElementById('out').innerHTML = html;
}

/**
 * Robust deutsches Parsing:
 * - entfernt €, %, Leerzeichen
 * - behandelt Tausenderpunkte: 1.234 -> 1234
 * - behandelt Komma als Dezimaltrenner: 0,35 -> 0.35
 * - funktioniert auch bei "1.234,56"
 */
function parseDE(id) {
  let s = String(document.getElementById(id).value ?? "").trim();
  s = s.replace(/€/g, "").replace(/%/g, "").replace(/\s+/g, "");

  if (s === "") return NaN;

  // Wenn Komma vorhanden => deutsches Dezimal: entferne Tausenderpunkte, Komma -> Punkt
  if (s.includes(",")) {
    s = s.replace(/\./g, "");   // Tausenderpunkte raus
    s = s.replace(",", ".");    // Dezimalkomma -> Punkt
  } else {
    // Kein Komma: Wenn mehrere Punkte, sind es sehr wahrscheinlich Tausenderpunkte
    const dots = (s.match(/\./g) || []).length;
    if (dots >= 2) s = s.replace(/\./g, "");
  }

  // Restliche Nicht-Zahlen-Zeichen entfernen (Sicherheitsnetz)
  s = s.replace(/[^0-9.\-]/g, "");
  return Number(s);
}

function compute() {
  const cap    = parseDE('cap');     // kWh
  const power  = parseDE('power');   // kW
  const start  = parseDE('start');   // %
  const target = parseDE('target');  // %
  const lossP  = parseDE('loss');    // %
  const price  = parseDE('price');   // €/kWh

  if (!isFinite(cap) || cap <= 0) throw new Error("Kapazität muss > 0 sein.");
  if (!isFinite(power) || power <= 0) throw new Error("Ladeleistung muss > 0 sein.");
  if (!isFinite(start) || !isFinite(target) || start < 0 || start > 100 || target < 0 || target > 100)
    throw new Error("Start/Ziel müssen Zahlen zwischen 0 und 100 sein.");
  if (target <= start) throw new Error("Ziel muss größer als Start sein.");
  if (!isFinite(price) || price < 0) throw new Error("Strompreis muss eine Zahl ≥ 0 sein (z. B. 0,35).");

  const deltaPct = target - start;           // Prozentpunkte
  const energyAkku = cap * (deltaPct / 100); // kWh im Akku (Energiezuwachs)

  const loss = Math.min(Math.max(lossP, 0), 90) / 100;
  const energyNetz = energyAkku / (1 - loss);  // kWh aus dem Netz (inkl. Verluste)

  const timeIdealH = energyAkku / power;
  const timeRealH  = energyNetz / power;       // Näherung: Verluste bedeuten mehr Netzenergie

  const costTotal = energyNetz * price;

  // Plausibilitätswarnungen (nur Hinweis, nicht blockierend)
  const warnings = [];
  if (cap > 200) warnings.push("Kapazität wirkt sehr hoch (>" + nf2.format(200) + " kWh). Prüfen Sie die Eingabe (keine Tausenderpunkte).");
  if (price > 5) warnings.push("Strompreis wirkt sehr hoch (>" + nf2.format(5) + " €/kWh). Prüfen Sie, ob z. B. 0,35 gemeint ist.");
  if (energyAkku > cap) warnings.push("Energie (Akku) ist größer als Kapazität – Eingaben prüfen.");

  return { cap, power, start, target, lossP, price, deltaPct, energyAkku, energyNetz, timeIdealH, timeRealH, costTotal, warnings };
}

function getEntries() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

function appendEntry(r) {
  const now = new Date().toLocaleString("de-DE");
  const entries = getEntries();
  entries.push({
    date: now,
    cap: r.cap, power: r.power, start: r.start, target: r.target, loss: r.lossP, price: r.price,
    deltaPct: r.deltaPct,
    energyAkku: r.energyAkku, energyNetz: r.energyNetz,
    timeIdealH: r.timeIdealH, timeRealH: r.timeRealH,
    costTotal: r.costTotal
  });
  saveEntries(entries);
}

function calcAndSave() {
  try {
    const r = compute();

    const warnHtml = r.warnings.length
      ? `<div class="warn">Achtung: ${r.warnings.map(w => "• " + w).join("<br>")}</div><br>`
      : "";

    show(
      warnHtml +
      `Energie (Akku): <b>${fmtKWh(r.energyAkku)}</b><br>` +
      `Energie (Netz): <b>${fmtKWh(r.energyNetz)}</b><br>` +
      `Ladezeit (ideal): <b>${fmtTime(r.timeIdealH)}</b><br>` +
      `Ladezeit (real): <b>${fmtTime(r.timeRealH)}</b><br><br>` +
      `Gesamtkosten: <b>${fmtEUR(r.costTotal)}</b><br>` +
      `<div class="mono">Kostenformel: ${nf2.format(r.energyNetz)} kWh × ${nf3.format(r.price)} €/kWh = ${nf2.format(r.costTotal)} €</div>` +
      `<br><small>Debug (eingelesene Werte): Kapazität=${nf2.format(r.cap)} kWh, Leistung=${nf2.format(r.power)} kW, Preis=${nf3.format(r.price)} €/kWh</small>`
    );

    appendEntry(r);
  } catch (e) {
    show(e.message || String(e));
  }
}

function exportCSV() {
  const entries = getEntries();
  if (entries.length === 0) return alert("Keine Einträge vorhanden.");

  let csv =
    "Datum;Kapazität kWh;Leistung kW;Start %;Ziel %;Delta %-Punkte;Verluste %;Preis €/kWh;" +
    "Energie Akku kWh;Energie Netz kWh;Ladezeit ideal h;Ladezeit real h;Gesamtkosten €\n";

  entries.forEach(e => {
    csv +=
      `${e.date};${e.cap};${e.power};${e.start};${e.target};${e.deltaPct};${e.loss};${e.price};` +
      `${Number(e.energyAkku).toFixed(2)};${Number(e.energyNetz).toFixed(2)};` +
      `${Number(e.timeIdealH).toFixed(2)};${Number(e.timeRealH).toFixed(2)};` +
      `${Number(e.costTotal).toFixed(2)}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ladevorgaenge.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function clearCSV() {
  localStorage.removeItem(STORAGE_KEY);
  alert("Alle gespeicherten Einträge gelöscht.");
}

// Initial: nur rechnen/anzeigen, nicht speichern
(function initialRender() { try { calcAndSave(); /* speichert! */ } catch (_) {} })();
</script>
</body>
</html>
