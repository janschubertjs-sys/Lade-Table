<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ladezeit & Kosten</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 24px auto; padding: 0 14px; }
    h1 { text-align: center; }
    label { display:block; margin-top: 12px; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-top: 6px; }
    button { margin-top: 14px; width: 100%; padding: 12px; font-size: 16px; font-weight: 600; }
    .out { margin-top: 18px; padding: 14px; background: #f3f3f3; border-radius: 10px; line-height: 1.6; }
    small { color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Ladezeit & Kosten</h1>

  <label>Akkukapazität (kWh)
    <input id="cap" type="text" value="69">
  </label>
  <label>Ladeleistung (kW)
    <input id="power" type="text" value="2">
  </label>
  <label>Ankunft (SoC in %)
    <input id="start" type="text" value="35">
  </label>
  <label>Ziel (SoC in %)
    <input id="target" type="text" value="80">
  </label>
  <label><small>Ladeverluste (%)</small>
    <input id="loss" type="text" value="12">
  </label>
  <label>Strompreis (€/kWh) — 0,35 oder 35 (Cent)
    <input id="price" type="text" value="0,35">
  </label>

  <button type="button" onclick="calcAndSave()">Berechnen (automatisch speichern)</button>
  <button type="button" onclick="exportCSV()">CSV exportieren (Excel-DE)</button>
  <button type="button" onclick="clearCSV()">CSV zurücksetzen</button>

  <div class="out" id="out">Ergebnis erscheint hier.</div>

<script>
const STORAGE_KEY = "ladezeit_csv_v7";

/** robust: entfernt €/%/Leerzeichen; akzeptiert 1.234,56 und 1,234.56 */
function parseLoose(id) {
  let s = String(document.getElementById(id).value ?? "").trim();
  s = s.replace(/€/g, "").replace(/%/g, "").replace(/\s+/g, "");
  if (s === "") return NaN;

  const hasComma = s.includes(",");
  const hasDot = s.includes(".");
  if (hasComma && hasDot) {
    const lastComma = s.lastIndexOf(",");
    const lastDot = s.lastIndexOf(".");
    if (lastComma > lastDot) s = s.replace(/\./g, "").replace(",", ".");
    else s = s.replace(/,/g, "");
  } else if (hasComma) s = s.replace(",", ".");
  return Number(s);
}

function fmtTime(hours) {
  const totalMinutes = Math.round(hours * 60);
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${h} h ${String(m).padStart(2,'0')} min`;
}

function show(html) { document.getElementById('out').innerHTML = html; }

/** Excel-DE: Dezimalpunkt -> Dezimalkomma */
function toDE(n, digits=2) {
  if (!isFinite(n)) return "";
  return n.toFixed(digits).replace(".", ",");
}

/** Excel: sicherer Datumsstring (YYYY-MM-DD HH:MM:SS) */
function excelDateString(d = new Date()) {
  const pad = (x) => String(x).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function compute() {
  let capKWh = parseLoose('cap');
  const powerKW = parseLoose('power');
  const startPct = parseLoose('start');
  const targetPct = parseLoose('target');
  const lossPct = parseLoose('loss');
  let priceEurPerKWh = parseLoose('price');

  if (!isFinite(capKWh) || capKWh <= 0) throw new Error("Akkukapazität muss > 0 sein.");
  if (!isFinite(powerKW) || powerKW <= 0) throw new Error("Ladeleistung muss > 0 sein.");
  if (!isFinite(startPct) || !isFinite(targetPct) || startPct < 0 || startPct > 100 || targetPct < 0 || targetPct > 100)
    throw new Error("Ankunft/Ziel müssen Zahlen 0–100 sein.");
  if (targetPct <= startPct) throw new Error("Ziel muss größer als Ankunft sein.");
  if (!isFinite(priceEurPerKWh) || priceEurPerKWh < 0) throw new Error("Strompreis muss eine Zahl ≥ 0 sein.");

  if (capKWh > 1000) capKWh = capKWh / 1000;          // Wh -> kWh
  if (priceEurPerKWh > 5) priceEurPerKWh /= 100;      // Cent -> €

  const deltaPct = targetPct - startPct;
  const energyBatteryKWh = capKWh * (deltaPct / 100);
  const idealHours = energyBatteryKWh / powerKW;

  const loss = Math.min(Math.max(lossPct, 0), 90) / 100;
  const energyGridKWh = energyBatteryKWh / (1 - loss);
  const realHours = idealHours / (1 - loss);
  const totalCostEur = energyGridKWh * priceEurPerKWh;

  return { capKWh, powerKW, startPct, targetPct, lossPct, priceEurPerKWh,
           energyBatteryKWh, idealHours, energyGridKWh, realHours, totalCostEur };
}

function getEntries() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

function appendEntry(r) {
  const entries = getEntries();
  entries.push({
    date: excelDateString(new Date()),
    capKWh: r.capKWh, powerKW: r.powerKW, startPct: r.startPct, targetPct: r.targetPct,
    lossPct: r.lossPct, price: r.priceEurPerKWh,
    energyBatteryKWh: r.energyBatteryKWh, idealHours: r.idealHours,
    energyGridKWh: r.energyGridKWh, realHours: r.realHours,
    totalCostEur: r.totalCostEur
  });
  saveEntries(entries);
}

function calcAndSave() {
  try {
    const r = compute();
    show(
      `Energie in den Akku: <b>${r.energyBatteryKWh.toFixed(2)} kWh</b><br>` +
      `Energie aus dem Netz: <b>${r.energyGridKWh.toFixed(2)} kWh</b><br>` +
      `Ladezeit (ideal): <b>${fmtTime(r.idealHours)}</b><br>` +
      `Ladezeit (mit Verlusten): <b>${fmtTime(r.realHours)}</b><br><br>` +
      `Gesamtkosten: <b>${r.totalCostEur.toFixed(2)} €</b><br>` +
      `<div class="mono">Rechnung: ${r.energyGridKWh.toFixed(2)} kWh × ${r.priceEurPerKWh.toFixed(3)} €/kWh</div>`
    );
    appendEntry(r);
  } catch (e) {
    show(e.message || String(e));
  }
}

function exportCSV() {
  const entries = getEntries();
  if (entries.length === 0) { alert("Keine Einträge vorhanden."); return; }

  const header =
    "Datum;Kapazität kWh;Leistung kW;Start %;Ziel %;Verluste %;Preis €/kWh;" +
    "Energie Akku kWh;Ladezeit ideal h;Energie Netz kWh;Ladezeit real h;Gesamtkosten €\n";

  let csv = header;

  entries.forEach(e => {
    csv +=
      `${e.date};${toDE(e.capKWh,2)};${toDE(e.powerKW,2)};${toDE(e.startPct,0)};${toDE(e.targetPct,0)};${toDE(e.lossPct,2)};${toDE(e.price,3)};` +
      `${toDE(e.energyBatteryKWh,2)};${toDE(e.idealHours,2)};${toDE(e.energyGridKWh,2)};${toDE(e.realHours,2)};${toDE(e.totalCostEur,2)}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ladevorgaenge.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function clearCSV() {
  localStorage.removeItem(STORAGE_KEY);
  alert("Alle Einträge gelöscht.");
}
</script>
</body>
</html>
