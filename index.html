<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ladezeit & Kosten</title>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 24px auto; padding: 0 14px; }
    h1 { text-align: center; }
    label { display: block; margin-top: 12px; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-top: 6px; }
    button { margin-top: 14px; width: 100%; padding: 12px; font-size: 16px; font-weight: 600; }
    .out { margin-top: 18px; padding: 14px; background: #f3f3f3; border-radius: 10px; line-height: 1.6; }
    small { color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>

<body>
  <h1>Ladezeit & Kosten</h1>

  <label>Akkukapazität (kWh)
    <input id="cap" type="text" value="69">
  </label>

  <label>Ladeleistung (kW)
    <input id="power" type="text" value="2">
  </label>

  <label>Ankunft (%)
    <input id="start" type="text" value="35">
  </label>

  <label>Ziel (%)
    <input id="target" type="text" value="80">
  </label>

  <label><small>Ladeverluste (%)</small>
    <input id="loss" type="text" value="12">
  </label>

  <label>Strompreis (€/kWh)
    <input id="price" type="text" value="0,35">
  </label>

  <button type="button" onclick="calcAndSave()">Berechnen (automatisch speichern)</button>
  <button type="button" onclick="exportCSV()">CSV exportieren</button>
  <button type="button" onclick="clearCSV()">CSV zurücksetzen</button>

  <div class="out" id="out">Ergebnis erscheint hier.</div>

<script>
const STORAGE_KEY = "ladezeit_csv_v5";

/* Robust: erlaubt u.a. "0,35", "0,35 €", "35%", "1.234,56", "1,234.56" */
function parseDE(id) {
  let s = String(document.getElementById(id).value ?? "").trim();

  // Währungs-/Prozentzeichen und Texte entfernen
  s = s.replace(/€/g, "").replace(/%/g, "").replace(/\s+/g, "");

  if (s === "") return NaN;

  const hasComma = s.includes(",");
  const hasDot = s.includes(".");

  if (hasComma && hasDot) {
    // typischer DE-Fall: 1.234,56 -> Punkte raus, Komma zu Punkt
    // typischer US-Fall: 1,234.56 -> Kommas raus
    const lastComma = s.lastIndexOf(",");
    const lastDot = s.lastIndexOf(".");
    if (lastComma > lastDot) {
      s = s.replace(/\./g, "").replace(",", ".");
    } else {
      s = s.replace(/,/g, "");
    }
  } else if (hasComma) {
    // 0,35 -> 0.35
    s = s.replace(",", ".");
  } else {
    // nur Punkt oder nur Ziffern -> passt
  }

  return Number(s);
}

function fmtTime(hours) {
  const totalMinutes = Math.round(hours * 60);
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${h} h ${String(m).padStart(2,'0')} min`;
}

function show(html) {
  document.getElementById('out').innerHTML = html;
}

function compute() {
  const cap    = parseDE('cap');
  const power  = parseDE('power');
  const start  = parseDE('start');
  const target = parseDE('target');
  const lossP  = parseDE('loss');
  const price  = parseDE('price');

  if (!isFinite(cap) || cap <= 0) throw new Error("Kapazität muss > 0 sein.");
  if (!isFinite(power) || power <= 0) throw new Error("Ladeleistung muss > 0 sein.");
  if (!isFinite(start) || !isFinite(target) || start < 0 || start > 100 || target < 0 || target > 100)
    throw new Error("Start/Ziel müssen Zahlen zwischen 0 und 100 sein (ohne Text).");
  if (target <= start) throw new Error("Ziel muss größer als Start sein.");
  if (!isFinite(price) || price < 0) throw new Error("Strompreis muss eine Zahl ≥ 0 sein (z. B. 0,35).");

  const deltaPct = target - start;                 // Prozentpunkte
  const energy = cap * (deltaPct / 100);           // kWh im Akku
  const idealHours = energy / power;               // h

  const loss = Math.min(Math.max(lossP, 0), 90) / 100;
  const gridEnergy = energy / (1 - loss);          // kWh aus dem Netz
  const realHours = idealHours / (1 - loss);       // h (vereinfachte Näherung)

  const costTotal = gridEnergy * price;

  return {
    cap, power, start, target, lossP, price,
    deltaPct, energy, idealHours, loss,
    gridEnergy, realHours, costTotal
  };
}

function getEntries() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}
function saveEntries(entries) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}
function appendEntry(r) {
  const now = new Date().toLocaleString("de-DE");
  const entries = getEntries();
  entries.push({
    date: now,
    cap: r.cap, power: r.power, start: r.start, target: r.target,
    loss: r.lossP, price: r.price,
    deltaPct: r.deltaPct,
    energy: r.energy, idealHours: r.idealHours,
    gridEnergy: r.gridEnergy, realHours: r.realHours,
    costTotal: r.costTotal
  });
  saveEntries(entries);
}

function calcAndSave() {
  try {
    const r = compute();

    show(
      `Ladehub: <b>${r.deltaPct.toFixed(1)} %-Punkte</b><br>` +
      `Energie (Akku): <b>${r.energy.toFixed(2)} kWh</b><br>` +
      `Ideale Ladezeit: <b>${fmtTime(r.idealHours)}</b><br><br>` +
      `Verluste: <b>${r.lossP.toFixed(2)} %</b><br>` +
      `Energie aus dem Netz: <b>${r.gridEnergy.toFixed(2)} kWh</b><br>` +
      `Ladezeit inkl. Verluste: <b>${fmtTime(r.realHours)}</b><br><br>` +
      `Gesamtkosten: <b>${r.costTotal.toFixed(2)} €</b><br>` +
      `<div class="mono">Rechnung: ${r.gridEnergy.toFixed(2)} kWh × ${r.price.toFixed(3)} €/kWh = ${r.costTotal.toFixed(2)} €</div>` +
      `<br><small>Hinweis: Jeder Klick auf „Berechnen“ wird automatisch gespeichert.</small>`
    );

    appendEntry(r);
  } catch (e) {
    show(e.message || String(e));
  }
}

function exportCSV() {
  const entries = getEntries();
  if (entries.length === 0) {
    alert("Keine Einträge vorhanden.");
    return;
  }

  let csv =
    "Datum;Kapazität kWh;Leistung kW;Start %;Ziel %;Delta %-Punkte;Verluste %;Preis €/kWh;" +
    "Energie Akku kWh;Ladezeit ideal h;Energie Netz kWh;Ladezeit real h;Gesamtkosten €\n";

  entries.forEach(e => {
    csv +=
      `${e.date};${e.cap};${e.power};${e.start};${e.target};${e.deltaPct};${e.loss};${e.price};` +
      `${Number(e.energy).toFixed(2)};${Number(e.idealHours).toFixed(2)};` +
      `${Number(e.gridEnergy).toFixed(2)};${Number(e.realHours).toFixed(2)};` +
      `${Number(e.costTotal).toFixed(2)}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ladevorgaenge.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function clearCSV() {
  localStorage.removeItem(STORAGE_KEY);
  alert("Alle gespeicherten Einträge gelöscht.");
}

/* Initial anzeigen (ohne speichern) */
(function initialRender() {
  try {
    const r = compute();
    show(
      `Energie (Akku): <b>${r.energy.toFixed(2)} kWh</b><br>` +
      `Energie aus dem Netz: <b>${r.gridEnergy.toFixed(2)} kWh</b><br>` +
      `Gesamtkosten: <b>${r.costTotal.toFixed(2)} €</b><br>` +
      `<div class="mono">Rechnung: ${r.gridEnergy.toFixed(2)} kWh × ${r.price.toFixed(3)} €/kWh = ${r.costTotal.toFixed(2)} €</div>`
    );
  } catch (_) {}
})();
</script>
</body>
</html>
