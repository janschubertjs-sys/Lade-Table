<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ladezeit & Kosten</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 24px auto; padding: 0 14px; }
    h1 { text-align: center; }
    label { display:block; margin-top: 12px; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-top: 6px; }
    button { margin-top: 14px; width: 100%; padding: 12px; font-size: 16px; font-weight: 600; }
    .out { margin-top: 18px; padding: 14px; background: #f3f3f3; border-radius: 10px; line-height: 1.6; }
    small { color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Ladezeit & Kosten</h1>

  <label>Akkukapazität (kWh)
    <input id="cap" type="text" value="69">
  </label>

  <label>Ankunft (SoC in %)
    <input id="start" type="text" value="35">
  </label>

  <label>Ziel (SoC in %)
    <input id="target" type="text" value="80">
  </label>

  <label><small>Ladeverluste (%)</small>
    <input id="loss" type="text" value="12">
  </label>

  <label>Strompreis (€/kWh) — 0,35 oder 35 (Cent)
    <input id="price" type="text" value="0,35">
  </label>

  <button type="button" onclick="calcAndSave()">Berechnen (automatisch speichern)</button>
  <button type="button" onclick="exportCSV()">CSV exportieren</button>
  <button type="button" onclick="clearData()">Daten zurücksetzen</button>

  <div class="out" id="out">Ergebnis erscheint hier.</div>

<script>
const STORAGE_KEY = "ladezeit_entries_netonly";

/* robustes Einlesen: entfernt €/%/Leerzeichen; akzeptiert 1.234,56 und 1,234.56 */
function parseLoose(id) {
  let s = String(document.getElementById(id).value ?? "").trim();
  s = s.replace(/€/g, "").replace(/%/g, "").replace(/\s+/g, "");
  if (s === "") return NaN;

  const hasComma = s.includes(",");
  const hasDot = s.includes(".");
  if (hasComma && hasDot) {
    const lastComma = s.lastIndexOf(",");
    const lastDot = s.lastIndexOf(".");
    if (lastComma > lastDot) s = s.replace(/\./g, "").replace(",", ".");
    else s = s.replace(/,/g, "");
  } else if (hasComma) {
    s = s.replace(",", ".");
  }
  return Number(s);
}

function show(html) { document.getElementById('out').innerHTML = html; }

/* Excel-DE: Dezimalpunkt -> Dezimalkomma */
function toDE(n, digits=2) {
  if (!isFinite(n)) return "";
  return n.toFixed(digits).replace(".", ",");
}

/* Kurzdatum für Excel: TT.MM.JJJJ */
function excelDateString(d = new Date()) {
  const pad = (x) => String(x).padStart(2, "0");
  return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
}

/* Kernrechnung: Kosten NUR aus Energie Netz (inkl. Verluste) */
function compute() {
  let capKWh = parseLoose('cap');
  const startPct = parseLoose('start');
  const targetPct = parseLoose('target');
  const lossPctRaw = parseLoose('loss');
  let priceEurPerKWh = parseLoose('price');

  if (!isFinite(capKWh) || capKWh <= 0) throw new Error("Akkukapazität muss > 0 sein.");
  if (!isFinite(startPct) || !isFinite(targetPct) || startPct < 0 || startPct > 100 || targetPct < 0 || targetPct > 100)
    throw new Error("Ankunft/Ziel müssen Zahlen 0–100 sein.");
  if (targetPct <= startPct) throw new Error("Ziel muss größer als Ankunft sein.");
  if (!isFinite(priceEurPerKWh) || priceEurPerKWh < 0) throw new Error("Strompreis muss eine Zahl ≥ 0 sein.");

  // Plausibilitäts-Korrekturen
  if (capKWh > 1000) capKWh = capKWh / 1000;          // Wh -> kWh (falls 69000 eingegeben)
  if (priceEurPerKWh > 5) priceEurPerKWh /= 100;      // Cent -> € (falls 35 eingegeben)

  const lossPct = isFinite(lossPctRaw) ? lossPctRaw : 0;
  const loss = Math.min(Math.max(lossPct, 0), 90) / 100;  // 0..90%

  const deltaPct = targetPct - startPct;
  const energyBatteryKWh = capKWh * (deltaPct / 100);      // kWh in den Akku
  const energyGridKWh = energyBatteryKWh / (1 - loss);     // kWh aus Steckdose (höher bei Verlusten)
  const totalCostEur = energyGridKWh * priceEurPerKWh;     // Kosten nur aus Netzenergie

  return {
    capKWh, startPct, targetPct, lossPct, priceEurPerKWh,
    deltaPct, energyGridKWh, totalCostEur
  };
}

function getEntries() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

function appendEntry(r) {
  const entries = getEntries();
  entries.push({
    date: excelDateString(new Date()),
    capKWh: r.capKWh,
    startPct: r.startPct,
    targetPct: r.targetPct,
    lossPct: r.lossPct,
    price: r.priceEurPerKWh,
    energyGridKWh: r.energyGridKWh,
    totalCostEur: r.totalCostEur
  });
  saveEntries(entries);
  return entries.length;
}

function calcAndSave() {
  try {
    const r = compute();
    const count = appendEntry(r);

    show(
      `Hub: <b>${r.deltaPct.toFixed(1)} %-Punkte</b><br>` +
      `Energie aus Steckdose (Netz): <b>${r.energyGridKWh.toFixed(2)} kWh</b><br>` +
      `Kosten: <b>${r.totalCostEur.toFixed(2)} €</b><br>` +
      `<div class="mono">Rechnung: ${r.energyGridKWh.toFixed(2)} kWh × ${r.priceEurPerKWh.toFixed(3)} €/kWh</div>` +
      `<br><small>Gespeicherte Einträge: ${count}</small>`
    );
  } catch (e) {
    show(e.message || String(e));
  }
}

function exportCSV() {
  const entries = getEntries();
  if (entries.length === 0) { alert("Keine Einträge vorhanden."); return; }

  let csv =
    "Datum;Kapazität kWh;Start %;Ziel %;Verluste %;Preis €/kWh;Energie Netz kWh;Kosten €\n";

  entries.forEach(e => {
    csv +=
      `${e.date};${toDE(e.capKWh,2)};${toDE(e.startPct,0)};${toDE(e.targetPct,0)};${toDE(e.lossPct,2)};${toDE(e.price,3)};` +
      `${toDE(e.energyGridKWh,2)};${toDE(e.totalCostEur,2)}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ladevorgaenge.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function clearData() {
  localStorage.removeItem(STORAGE_KEY);
  alert("Alle gespeicherten Einträge wurden gelöscht.");
}
</script>
</body>
</html>
